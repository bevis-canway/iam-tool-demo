# 蓝鲸权限中心（BK-IAM）授权业务逻辑说明

## 1. 概述

蓝鲸权限中心（BK-IAM）是蓝鲸体系下的统一身份认证与权限控制系统，负责管理用户对各类资源的访问权限。授权业务逻辑是权限中心的核心功能，涉及权限模型定义、授权操作、权限校验、策略存储与管理等多个方面。

## 2. 权限模型定义

BK-IAM的权限模型由以下几个核心组件构成：

### 2.1 系统（System）
系统是权限管理的边界，每个接入权限中心的业务系统都有唯一的系统标识。

### 2.2 资源类型（Resource Type）
资源类型定义了可被授权的资源种类，如业务、主机、脚本等。

### 2.3 操作（Action）
操作定义了对资源可以执行的操作，如查看、编辑、删除等。

### 2.4 策略（Policy）
策略是将主体（用户/角色）与操作、资源关联起来的规则，是权限控制的核心。

## 3. 授权类型

BK-IAM支持多种授权类型，每种类型适用于不同的业务场景：

### 3.1 路径授权
- **策略类型**：StringPrefix策略
- **匹配方式**：基于路径前缀匹配
- **适用场景**：适用于层级结构资源，如对某个业务下的所有资源进行授权
- **接口**：`/api/v1/open/authorization/batch_path/`

### 3.2 属性授权
- **策略类型**：StringEquals策略
- **匹配方式**：基于属性值精确匹配
- **适用场景**：适用于基于特征的权限控制，如基于标签、状态等属性的授权
- **接口**：
  - `/api/v1/open/authorization/resource_creator_action_attribute/`（资源创建者属性授权）
  - `/api/v1/open/authorization/attribute/`（特定操作的属性授权）

### 3.3 新建关联授权
- **策略类型**：新建关联策略
- **匹配方式**：创建资源时自动授予创建者权限
- **适用场景**：创建具有特定属性资源时自动授予创建者相应权限
- **接口**：`/api/v1/open/authorization/resource_creator_action_attribute/`

## 4. 权限校验

权限校验是用户访问资源时的关键环节：

### 4.1 权限判定方式
- **精确匹配**（op: "eq"）：value为具体允许访问的资源ID
- **无限制访问**（op: "any"）：配合空value数组表示完全访问权限

### 4.2 全局权限查询
当resources为空数组时，表示查询用户对该资源类型的全局访问权限。

### 4.3 路径权限校验
- 使用StringPrefix策略基于路径前缀匹配
- 适用于层级结构资源（如`{"StringPrefix":{"resource._bk_iam_path_":["/type1,*/type2,id/"]}}`）
- 检查业务层级权限时需通过资源路径结构验证

## 5. 策略存储与管理

BK-IAM采用双层数据存储架构：

### 5.1 存储结构
- **SaaS数据库**：policy_policy表存储策略信息
- **后台权限引擎**：高性能权限校验引擎

### 5.2 数据一致性
双层存储确保了数据持久化和高效校验的平衡，但也需要特别注意数据一致性维护。

## 6. 授权接口调用链路

### 6.1 批量资源拓扑授权
```
API层 → 业务层 → 服务层 → 后台alter_policies()接口
接口：/api/v1/open/authorization/batch_path/
```

### 6.2 新建关联属性授权
```
API层 → 业务层 → 服务层 → 后台alter_policies()接口
接口：/api/v1/open/authorization/resource_creator_action_attribute/
```

## 7. 异常处理与回滚机制

### 7.1 回滚步骤
1. 查询`policy_backendpolicy`表获取后台策略ID
2. 调用`delete_policies()`删除后台数据
3. 执行SQL删除SaaS数据库中的策略记录

### 7.2 异常回滚通用规范
- 在执行授权操作前应记录起始时间或查询授权前的状态
- 授权失败时，优先通过`system_id`、`subject_type`、`subject_id`、`action_id`及时间范围组合条件精准删除新增的策略记录
- 避免使用全表扫描式删除，确保回滚操作不影响其他正常数据
- 建议在测试环境验证回滚SQL后再应用于生产环境
- 关键操作建议封装为事务或提供配套的反向操作接口
- 涉及多系统时必须实现双向数据清理，确保最终一致性

## 8. 最佳实践

### 8.1 授权类型选择原则
- 路径授权关注资源层级关系
- 属性授权关注资源特征
- 应根据业务模型选择合适的授权类型

### 8.2 接口使用原则
- `batch_path`接口专用于路径授权，不支持属性授权，必须使用专用接口
- 属性授权接口需要注册到ESB（企业服务总线）配置中以实现外部调用

### 8.3 权限设计原则
- 推荐先通过路径前缀策略授权，再用具体路径验证
- 当需要对某业务下所有资源无差别授权时，优先采用属性授权避免路径依赖